<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin</title>

<style>
body{font-family:sans-serif;padding:20px}
input,textarea{width:100%;margin:5px 0;padding:8px}
button{padding:6px 10px;margin:3px}
.card{border:1px solid #ddd;padding:10px;margin:10px 0}
</style>
</head>

<body>

<div id="login">
<h3>Login</h3>
<input id="pass" type="password">
<button onclick="login()">Login</button>
</div>

<div id="panel" style="display:none">

<h2>Dashboard</h2>
<div id="stats"></div>

<h3>Add Post</h3>
<input type="file" id="file">
<input id="title" placeholder="title">
<textarea id="desc"></textarea>
<input id="tags" placeholder="tags">
<button onclick="add()">Add</button>

<hr>
<div id="list"></div>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbwOSjiZoFntn7fQqMDkM-fQntp_fsQX_xBdiuOOkB97nk6vZdl8kDTd5EQV4AMeWCi4Ow/exec";
let PASS="";

async function login(){
 PASS=pass.value;

 await fetch(API,{method:'POST',mode:'no-cors',
 body:JSON.stringify({action:'login',pass:PASS})});

 login.style.display="none";
 panel.style.display="block";
 load();
}

async function upload(){
 const f=file.files[0];
 const r=new FileReader();
 return new Promise(res=>{
  r.onload=async ()=>{
   const out=await fetch(API,{method:'POST',
   body:JSON.stringify({action:'upload',image:r.result,pass:PASS})});
   res(await out.text());
  };
  r.readAsDataURL(f);
 });
}

async function add(){
 const url=await upload();
 await fetch(API,{method:'POST',mode:'no-cors',
 body:JSON.stringify({action:'add',url,title:title.value,desc:desc.value,tags:tags.value,pass:PASS})});
 load();
}

async function load(){
 const r=await fetch(API);
 const data=await r.json();

 stats.innerText="Posts: "+data.length+" | Likes: "+data.reduce((a,b)=>a+b.likes,0);

 list.innerHTML="";

 data.forEach(i=>{
  const d=document.createElement("div");
  d.className="card";
  d.innerHTML=`
   <img src="${i.imageUrl}" width=100><br>
   <input value="${i.title}" onchange="edit(${i.id},this.value,'title')">
   <button onclick="del(${i.id})">Delete</button>
  `;
  list.appendChild(d);
 });
}

function edit(id,val){
 fetch(API,{method:'POST',mode:'no-cors',
 body:JSON.stringify({action:'edit',id,url:'',title:val,desc:'',tags:'',pass:PASS})});
}

function del(id){
 fetch(API,{method:'POST',mode:'no-cors',
 body:JSON.stringify({action:'delete',id,pass:PASS})});
 load();
}
</script>

</body>
</html>
